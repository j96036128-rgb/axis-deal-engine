{% extends "base.html" %}

{% block title %}{{ submission.property_id }} - Axis Allocation{% endblock %}

{% block content %}
<div class="detail-container">
    <header class="detail-header">
        <div class="header-content">
            <a href="/submit/admin" class="back-link">&larr; Back to All Submissions</a>
            <h1>{{ submission.full_address }}</h1>
            <p class="property-id">{{ submission.property_id }}</p>
        </div>
        <div class="header-status">
            <span class="status-badge status-{{ submission.status }}">
                {{ submission.status.replace('_', ' ').title() }}
            </span>
        </div>
    </header>

    <div class="detail-grid">
        <!-- Property Information -->
        <section class="detail-section">
            <h2>Property Information</h2>

            <div class="info-grid">
                <div class="info-item">
                    <span class="label">Address</span>
                    <span class="value">{{ submission.full_address }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Postcode</span>
                    <span class="value">{{ submission.postcode }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Property Type</span>
                    <span class="value">{{ submission.property_type.replace('-', ' ').replace('_', ' ').title() }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Tenure</span>
                    <span class="value">{{ submission.tenure.title() }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Floor Area</span>
                    <span class="value">{{ submission.floor_area_sqm }} sqm</span>
                </div>
                <div class="info-item">
                    <span class="label">Guide Price</span>
                    <span class="value highlight">£{{ "{:,}".format(submission.guide_price) }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Sale Route</span>
                    <span class="value">{{ submission.sale_route.replace('_', ' ').title() }}</span>
                </div>
                {% if submission.bedrooms %}
                <div class="info-item">
                    <span class="label">Bedrooms</span>
                    <span class="value">{{ submission.bedrooms }}</span>
                </div>
                {% endif %}
                {% if submission.bathrooms %}
                <div class="info-item">
                    <span class="label">Bathrooms</span>
                    <span class="value">{{ submission.bathrooms }}</span>
                </div>
                {% endif %}
                {% if submission.year_built %}
                <div class="info-item">
                    <span class="label">Year Built</span>
                    <span class="value">{{ submission.year_built }}</span>
                </div>
                {% endif %}
                {% if submission.council_tax_band %}
                <div class="info-item">
                    <span class="label">Council Tax Band</span>
                    <span class="value">{{ submission.council_tax_band }}</span>
                </div>
                {% endif %}
                {% if submission.epc_rating %}
                <div class="info-item">
                    <span class="label">EPC Rating</span>
                    <span class="value">{{ submission.epc_rating }}</span>
                </div>
                {% endif %}
            </div>

            {% if submission.tenure == 'leasehold' %}
            <h3>Leasehold Details</h3>
            <div class="info-grid">
                {% if submission.lease_years_remaining %}
                <div class="info-item">
                    <span class="label">Lease Remaining</span>
                    <span class="value">{{ submission.lease_years_remaining }} years</span>
                </div>
                {% endif %}
                {% if submission.ground_rent_annual %}
                <div class="info-item">
                    <span class="label">Ground Rent</span>
                    <span class="value">£{{ "{:,}".format(submission.ground_rent_annual) }}/year</span>
                </div>
                {% endif %}
                {% if submission.service_charge_annual %}
                <div class="info-item">
                    <span class="label">Service Charge</span>
                    <span class="value">£{{ "{:,}".format(submission.service_charge_annual) }}/year</span>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </section>

        <!-- Agent Information -->
        <section class="detail-section">
            <h2>Agent Information</h2>

            <div class="info-grid">
                <div class="info-item">
                    <span class="label">Firm</span>
                    <span class="value">{{ submission.agent_firm }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Agent Name</span>
                    <span class="value">{{ submission.agent_name }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Email</span>
                    <span class="value">{{ submission.agent_email }}</span>
                </div>
            </div>
        </section>

        <!-- Completeness Check -->
        <section class="detail-section">
            <h2>Completeness Check</h2>

            {% if completeness.is_complete %}
            <div class="completeness-badge complete">
                <span class="icon">&#10003;</span>
                <span>All required documents uploaded</span>
            </div>
            {% else %}
            <div class="completeness-badge incomplete">
                <span class="icon">!</span>
                <span>Missing documents - submission incomplete</span>
            </div>

            {% if completeness.missing_documents %}
            <div class="missing-list">
                <h4>Missing Documents:</h4>
                <ul>
                    {% for doc in completeness.missing_documents %}
                    <li>{{ doc.replace('_', ' ').title() }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% endif %}

            <p class="doc-count">
                Documents uploaded: <strong>{{ completeness.document_count }}</strong> of
                <strong>{{ completeness.required_document_count }}</strong> required
            </p>

            {% if submission.documents %}
            <div class="document-list">
                <h4>Uploaded Documents:</h4>
                <ul>
                    {% for doc in submission.documents %}
                    <li>
                        <span class="doc-type">{{ doc.document_type.replace('_', ' ').title() }}</span>
                        <span class="doc-file">{{ doc.filename }}</span>
                        <span class="doc-size">{{ (doc.file_size_bytes / 1024)|round(1) }} KB</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </section>

        <!-- Trust & Integrity -->
        <section class="detail-section">
            <h2>Trust &amp; Integrity</h2>

            <!-- Hash Chain Status -->
            <div class="integrity-section">
                <h4>Hash Chain Integrity</h4>
                {% if integrity and integrity.chain_valid %}
                <div class="integrity-badge valid">
                    <span class="icon">&#128274;</span>
                    <span>Hash chain intact - No tampering detected</span>
                </div>
                {% elif integrity %}
                <div class="integrity-badge invalid">
                    <span class="icon">&#9888;</span>
                    <span>Hash chain broken - {{ integrity.verification_error or 'Integrity compromised' }}</span>
                </div>
                {% else %}
                <div class="integrity-badge pending">
                    <span class="icon">&#8987;</span>
                    <span>Integrity check pending</span>
                </div>
                {% endif %}

                {% if integrity and integrity.current_version_hash %}
                <div class="hash-display">
                    <span class="hash-label">Current Version Hash:</span>
                    <code class="hash-value">{{ integrity.current_version_hash[:16] }}...{{ integrity.current_version_hash[-8:] }}</code>
                </div>
                {% endif %}
            </div>

            <!-- Verification Summary -->
            {% if verification_summary %}
            <div class="verification-section">
                <h4>Fact Verification Status</h4>

                <div class="verification-stats">
                    <div class="stat">
                        <span class="stat-value verified">{{ verification_summary.verified_count }}</span>
                        <span class="stat-label">Verified</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value unverified">{{ verification_summary.unverified_count }}</span>
                        <span class="stat-label">Unverified</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value submitted">{{ verification_summary.submitted_count }}</span>
                        <span class="stat-label">Pending</span>
                    </div>
                    {% if verification_summary.disputed_count > 0 %}
                    <div class="stat">
                        <span class="stat-value disputed">{{ verification_summary.disputed_count }}</span>
                        <span class="stat-label">Disputed</span>
                    </div>
                    {% endif %}
                </div>

                <div class="verification-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ verification_summary.verification_percentage }}%"></div>
                    </div>
                    <span class="progress-text">{{ verification_summary.verification_percentage|round(1) }}% verified</span>
                </div>

                {% if verification_summary.has_disputes %}
                <div class="dispute-warning">
                    <span class="icon">&#9888;</span>
                    <span>This submission has disputed facts that require resolution</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Trust Level Indicator -->
            <div class="trust-level-section">
                <h4>Trust Level</h4>
                {% if verification_summary and verification_summary.is_fully_verified and integrity and integrity.chain_valid %}
                <div class="trust-badge high">
                    <span class="trust-icon">&#9733;&#9733;&#9733;</span>
                    <span class="trust-label">HIGH TRUST</span>
                    <span class="trust-desc">All facts verified, hash chain intact</span>
                </div>
                {% elif verification_summary and verification_summary.verification_percentage >= 50 %}
                <div class="trust-badge medium">
                    <span class="trust-icon">&#9733;&#9733;&#9734;</span>
                    <span class="trust-label">MEDIUM TRUST</span>
                    <span class="trust-desc">Partial verification complete</span>
                </div>
                {% else %}
                <div class="trust-badge low">
                    <span class="trust-icon">&#9733;&#9734;&#9734;</span>
                    <span class="trust-label">LOW TRUST</span>
                    <span class="trust-desc">Facts pending verification</span>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Status Management -->
        <section class="detail-section">
            <h2>Status Management</h2>

            <form method="POST" action="/submit/admin/{{ submission.property_id }}/status" class="status-form">
                <div class="form-group">
                    <label for="new_status">Update Status</label>
                    <select id="new_status" name="new_status">
                        {% for status in statuses %}
                        <option value="{{ status }}" {% if submission.status == status %}selected{% endif %}>
                            {{ status.replace('_', ' ').title() }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="note">Note (optional)</label>
                    <input type="text" id="note" name="note" placeholder="Reason for status change...">
                </div>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </form>
        </section>

        <!-- Version History -->
        <section class="detail-section full-width">
            <h2>Version History</h2>

            <div class="version-timeline">
                {% for version in history|reverse %}
                <div class="version-item">
                    <div class="version-marker">
                        <span class="version-number">v{{ version.version_number }}</span>
                    </div>
                    <div class="version-content">
                        <div class="version-header">
                            <span class="version-action">{{ version.action.replace('_', ' ').title() }}</span>
                            <span class="version-status status-{{ version.status }}">{{ version.status.replace('_', ' ').title() }}</span>
                        </div>
                        <div class="version-meta">
                            <span class="version-by">{{ version.action_by }}</span>
                            <span class="version-time">{{ version.timestamp }}</span>
                        </div>
                        {% if version.action_note %}
                        <p class="version-note">{{ version.action_note }}</p>
                        {% endif %}
                        {% if version.version_hash %}
                        <div class="version-hash">
                            <span class="hash-icon">&#128273;</span>
                            <code>{{ version.version_hash[:12] }}...</code>
                            {% if version.previous_version_hash %}
                            <span class="chain-link">&larr; {{ version.previous_version_hash[:8] }}...</span>
                            {% else %}
                            <span class="chain-origin">(genesis)</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
    </div>

    <!-- API Endpoint Reference -->
    <section class="api-section">
        <h2>Read-Only API Endpoints</h2>
        <div class="api-endpoints">
            <div class="endpoint">
                <code>GET /submit/api/property/{{ submission.property_id }}</code>
                <span>Full submission data</span>
            </div>
            <div class="endpoint">
                <code>GET /submit/api/property/{{ submission.property_id }}/history</code>
                <span>Version history</span>
            </div>
        </div>
    </section>
</div>

<style>
.detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
}

.back-link {
    color: #4a90d9;
    text-decoration: none;
    font-size: 0.875rem;
}

.back-link:hover {
    text-decoration: underline;
}

.detail-header h1 {
    margin: 0.5rem 0 0;
    font-size: 1.5rem;
}

.property-id {
    margin: 0.25rem 0 0;
    font-family: monospace;
    color: #666;
}

.status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-weight: 500;
}

.status-draft { background: #f3f4f6; color: #374151; }
.status-incomplete { background: #fef3c7; color: #92400e; }
.status-submitted { background: #dbeafe; color: #1e40af; }
.status-under_review { background: #e0e7ff; color: #3730a3; }
.status-unevaluated { background: #f3e8ff; color: #6b21a8; }
.status-evaluated { background: #dcfce7; color: #166534; }
.status-approved { background: #d1fae5; color: #065f46; }
.status-rejected { background: #fee2e2; color: #991b1b; }
.status-archived { background: #e5e7eb; color: #374151; }
.status-withdrawn { background: #fef2f2; color: #991b1b; }

.detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.detail-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1.5rem;
}

.detail-section.full-width {
    grid-column: 1 / -1;
}

.detail-section h2 {
    margin: 0 0 1rem;
    font-size: 1.125rem;
    color: #1a1a2e;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
}

.detail-section h3 {
    margin: 1.5rem 0 0.75rem;
    font-size: 1rem;
    color: #333;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.info-item {
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.info-item .label {
    display: block;
    font-size: 0.7rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-item .value {
    display: block;
    font-weight: 500;
    color: #1a1a2e;
}

.info-item .value.highlight {
    font-size: 1.125rem;
    color: #166534;
}

.completeness-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.completeness-badge.complete {
    background: #dcfce7;
    color: #166534;
}

.completeness-badge.incomplete {
    background: #fef3c7;
    color: #92400e;
}

.completeness-badge .icon {
    font-size: 1.25rem;
}

.missing-list {
    background: #fef3c7;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.missing-list h4 {
    margin: 0 0 0.5rem;
    font-size: 0.875rem;
}

.missing-list ul {
    margin: 0;
    padding-left: 1.25rem;
}

.doc-count {
    color: #666;
    margin-bottom: 1rem;
}

.document-list h4 {
    margin: 0 0 0.5rem;
    font-size: 0.875rem;
}

.document-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.document-list li {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 0.25rem;
}

.doc-type {
    font-weight: 500;
    min-width: 120px;
}

.doc-file {
    flex: 1;
    font-family: monospace;
    font-size: 0.875rem;
}

.doc-size {
    color: #666;
    font-size: 0.75rem;
}

.status-form {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.status-form .form-group {
    flex: 1;
}

.status-form label {
    display: block;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.status-form select,
.status-form input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.version-timeline {
    border-left: 2px solid #e0e0e0;
    padding-left: 1.5rem;
    margin-left: 0.5rem;
}

.version-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.version-marker {
    position: absolute;
    left: -2rem;
    width: 1rem;
    height: 1rem;
    background: #4a90d9;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.version-number {
    font-size: 0;
}

.version-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
}

.version-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.version-action {
    font-weight: 600;
}

.version-meta {
    font-size: 0.75rem;
    color: #666;
}

.version-meta span {
    margin-right: 1rem;
}

.version-note {
    margin: 0.5rem 0 0;
    font-style: italic;
    color: #555;
}

.api-section {
    margin-top: 2rem;
    background: #1a1a2e;
    border-radius: 8px;
    padding: 1.5rem;
    color: white;
}

.api-section h2 {
    margin: 0 0 1rem;
    font-size: 1rem;
}

.api-endpoints {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.endpoint {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.endpoint code {
    background: rgba(255,255,255,0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.endpoint span {
    color: #aaa;
    font-size: 0.875rem;
}

.btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.btn-primary {
    background: #1a1a2e;
    color: white;
}

.btn-primary:hover {
    background: #2d2d4a;
}

/* === Trust & Integrity Styles === */

.integrity-section,
.verification-section,
.trust-level-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}

.integrity-section:last-child,
.verification-section:last-child,
.trust-level-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.integrity-section h4,
.verification-section h4,
.trust-level-section h4 {
    margin: 0 0 0.75rem;
    font-size: 0.875rem;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.integrity-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    font-weight: 500;
    margin-bottom: 0.75rem;
}

.integrity-badge.valid {
    background: #dcfce7;
    color: #166534;
}

.integrity-badge.invalid {
    background: #fee2e2;
    color: #991b1b;
}

.integrity-badge.pending {
    background: #f3f4f6;
    color: #374151;
}

.integrity-badge .icon {
    font-size: 1.25rem;
}

.hash-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.hash-label {
    color: #666;
}

.hash-value {
    background: #f3f4f6;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.75rem;
}

/* Verification Stats */
.verification-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.verification-stats .stat {
    text-align: center;
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    border-radius: 4px;
    min-width: 70px;
}

.verification-stats .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
}

.verification-stats .stat-value.verified { color: #16a34a; }
.verification-stats .stat-value.unverified { color: #6b7280; }
.verification-stats .stat-value.submitted { color: #2563eb; }
.verification-stats .stat-value.disputed { color: #dc2626; }

.verification-stats .stat-label {
    display: block;
    font-size: 0.7rem;
    color: #666;
    text-transform: uppercase;
}

/* Verification Progress Bar */
.verification-progress {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #16a34a);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    min-width: 100px;
    text-align: right;
}

/* Dispute Warning */
.dispute-warning {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: #fef3c7;
    color: #92400e;
    border-radius: 4px;
    font-size: 0.875rem;
}

/* Trust Level Badge */
.trust-badge {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    border-radius: 8px;
}

.trust-badge.high {
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    border: 1px solid #86efac;
}

.trust-badge.medium {
    background: linear-gradient(135deg, #fef9c3, #fef08a);
    border: 1px solid #fde047;
}

.trust-badge.low {
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    border: 1px solid #d1d5db;
}

.trust-icon {
    font-size: 1.5rem;
}

.trust-badge.high .trust-icon { color: #16a34a; }
.trust-badge.medium .trust-icon { color: #ca8a04; }
.trust-badge.low .trust-icon { color: #6b7280; }

.trust-label {
    font-weight: 700;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
}

.trust-badge.high .trust-label { color: #166534; }
.trust-badge.medium .trust-label { color: #854d0e; }
.trust-badge.low .trust-label { color: #374151; }

.trust-desc {
    font-size: 0.75rem;
    color: #555;
    margin-left: auto;
}

/* Version Hash Display */
.version-hash {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: #666;
}

.version-hash .hash-icon {
    font-size: 0.875rem;
}

.version-hash code {
    background: rgba(0, 0, 0, 0.05);
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    font-family: monospace;
}

.version-hash .chain-link {
    color: #4a90d9;
}

.version-hash .chain-origin {
    color: #16a34a;
    font-style: italic;
}
</style>
{% endblock %}
